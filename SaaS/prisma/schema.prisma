generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// Enums
// ========================================

enum StorageType {
  frozen
  chilled
  room
}

enum RecipeCategory {
  main
  side
  soup
  dessert
}

enum MealType {
  breakfast
  lunch
  dinner
}

enum VolumeFeeling {
  less
  just
  much
}

enum LeftoverAmount {
  none
  half
  almostAll
}

enum UserRole {
  CHEF
  MANAGER
}

enum UserStatus {
  ACTIVE
  INVITED
  DISABLED
}

enum ExclusionScope {
  CHEF    // 司厨個人が作れない
  VESSEL  // 船の環境で作れない
}

enum OrderStatus {
  DRAFT      // 下書き（カート状態）
  CONFIRMED  // 発注確定
  SHIPPED    // 出荷済み
  DELIVERED  // 納品完了
  CANCELLED  // キャンセル
}

// ========================================
// 認証・テナント関連（新規追加）
// ========================================

model Company {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique

  // リレーション
  vessels   Vessel[]
  users     User[]
  ingredients Ingredient[]
  recipes   Recipe[]
  auditLogs AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Vessel {
  id        String  @id @default(cuid())
  name      String
  imoNumber String?

  // 予算設定 (船会社が設定)
  minBudgetUsagePercent Int @default(90) // 予算消化率の下限（%）デフォルト90%
  budgetPerDay          Int @default(1400) // 1人1日あたりの予算（円）

  // 献立生成デフォルト設定 (司厨が設定)
  defaultSeason         String?  // spring/summer/autumn/winter
  defaultMaxCookingTime Int?     // 調理時間上限（分）

  // テナント紐付け
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String

  // リレーション
  memberships UserVesselMembership[]
  menuPlans   MenuPlan[]
  feedbacks   MealFeedback[]
  procurementAdjustments ProcurementAdjustment[]
  crewMembers CrewMember[]
  recipeExclusions RecipeExclusion[]
  orders      Order[]  // 発注履歴

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  phone         String?
  passwordHash  String?
  role          UserRole @default(CHEF)
  status        UserStatus @default(ACTIVE)
  authUserId    String?  @unique
  lastLoginAt   DateTime?
  invitedAt     DateTime?
  disabledAt    DateTime?

  // テナント紐付け
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId     String

  // 船との紐付け
  vesselMemberships UserVesselMembership[]

  // レシピ除外
  recipeExclusions RecipeExclusion[]

  // 監査ログ
  auditLogsAsActor  AuditLog[] @relation("AuditActor")
  auditLogsAsTarget AuditLog[] @relation("AuditTarget")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([companyId])
  @@index([role])
  @@index([status])
}

model UserVesselMembership {
  id       String    @id @default(cuid())
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   String
  vessel   Vessel    @relation(fields: [vesselId], references: [id], onDelete: Cascade)
  vesselId String
  role     UserRole?

  createdAt DateTime @default(now())

  @@unique([userId, vesselId])
  @@index([vesselId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  vesselId     String?

  createdAt    DateTime @default(now())

  @@index([userId])
}

model AuditLog {
  id           String   @id @default(cuid())
  company      Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId    String
  actorUser    User?   @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)
  actorUserId  String?
  targetUser   User?   @relation("AuditTarget", fields: [targetUserId], references: [id], onDelete: SetNull)
  targetUserId String?
  action       String
  metadata     Json?
  createdAt    DateTime @default(now())

  @@index([companyId])
  @@index([actorUserId])
  @@index([targetUserId])
}

// ========================================
// 既存モデル（companyId / vesselId 追加）
// ========================================

model Ingredient {
  id                String             @id @default(cuid())
  name              String
  storageType       StorageType
  unit              String
  costPerUnit       Float              @default(0)

  // 商社プラットフォーム用フィールド
  price             Int                @default(0)    // 標準単価（円）
  isBonus           Boolean            @default(false) // ロス食材（Boost食材）フラグ
  supplierId        String?            // 仕入れ先ID
  supplier          Supplier?          @relation(fields: [supplierId], references: [id])

  // テナント紐付け
  company           Company?           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId         String?

  recipeIngredients RecipeIngredient[]
  procurementAdjustments ProcurementAdjustment[]
  orderItems        OrderItem[]        // 発注明細
  supplierProducts  SupplierProduct[]  // この食材に対応するサプライヤー商品

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([companyId])
  @@index([supplierId])
  @@index([isBonus])
}

model ProcurementAdjustment {
  id            String     @id @default(cuid())
  ingredient    Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  ingredientId  String
  startDate     String
  endDate       String
  plannedAmount Float
  orderAmount   Float
  inStock       Boolean    @default(false)
  unitPrice     Float

  // テナント紐付け
  vessel        Vessel?    @relation(fields: [vesselId], references: [id], onDelete: Cascade)
  vesselId      String?

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@unique([ingredientId, startDate, endDate])
  @@index([vesselId])
}

model Recipe {
  id                String             @id @default(cuid())
  name              String
  category          RecipeCategory
  calories          Float
  protein           Float
  salt              Float
  costPerServing    Float

  // テナント紐付け
  company           Company?           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId         String?

  ingredients       RecipeIngredient[]
  menuPlans         MenuPlanRecipe[]
  exclusions        RecipeExclusion[]

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([companyId])
}

model RecipeIngredient {
  id           String     @id @default(cuid())
  amount       Float
  recipe       Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId     String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  ingredientId String

  @@unique([recipeId, ingredientId])
}

model MenuPlan {
  id          String            @id @default(cuid())
  date        String
  mealType    MealType
  healthScore Float
  crewCount   Int               @default(20) // 乗船人数（調達計算用）
  budgetPerPerson Int           @default(1200) // 1人1日あたり予算（円）

  // フィードバック締め状態
  isClosed    Boolean           @default(false)
  closedAt    DateTime?

  // テナント紐付け
  vessel      Vessel?           @relation(fields: [vesselId], references: [id], onDelete: Cascade)
  vesselId    String?

  recipeLinks MenuPlanRecipe[]
  feedbacks   MealFeedback[]

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@unique([vesselId, date, mealType])
  @@index([vesselId])
}

model MenuPlanRecipe {
  id          String   @id @default(cuid())
  menuPlan    MenuPlan @relation(fields: [menuPlanId], references: [id], onDelete: Cascade)
  menuPlanId  String
  recipe      Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId    String

  @@unique([menuPlanId, recipeId])
}

model MealFeedback {
  id            String        @id @default(cuid())
  date          String
  mealType      MealType
  satisfaction  Int
  volumeFeeling VolumeFeeling
  leftover      LeftoverAmount
  comment       String?
  
  // 写真撮影機能用
  photoUrl      String?       // 撮影写真のURL
  reasonTags    String?       // 理由タグ（JSON配列）例: ["味", "量"]

  menuPlan      MenuPlan?      @relation(fields: [menuPlanId], references: [id], onDelete: Cascade)
  menuPlanId    String?

  // テナント紐付け
  vessel        Vessel?       @relation(fields: [vesselId], references: [id], onDelete: Cascade)
  vesselId      String?

  // 船員紐付け（カードベースフィードバック用）
  crewMember    CrewMember?   @relation(fields: [crewMemberId], references: [id])
  crewMemberId  String?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([vesselId])
  @@index([date])
  @@index([crewMemberId])
}

// ========================================
// 船員（カードベース識別用）
// ========================================

model CrewMember {
  id        String   @id @default(cuid())
  name      String
  cardCode  String   @unique  // QRカードに印字する一意コード

  vessel    Vessel   @relation(fields: [vesselId], references: [id], onDelete: Cascade)
  vesselId  String

  mealFeedbacks MealFeedback[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vesselId])
}

// ========================================
// レシピ除外（代替理由による学習）
// ========================================

model RecipeExclusion {
  id        String         @id @default(cuid())
  
  recipe    Recipe         @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId  String
  
  scope     ExclusionScope
  reason    String         // 除外理由の詳細
  
  // CHEF scope: この司厨のみ除外
  user      User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String?
  
  // VESSEL scope: この船舶のみ除外
  vessel    Vessel?        @relation(fields: [vesselId], references: [id], onDelete: Cascade)
  vesselId  String?
  
  createdAt DateTime       @default(now())
  
  @@unique([recipeId, userId, scope])
  @@unique([recipeId, vesselId, scope])
  @@index([userId])
  @@index([vesselId])
}

// ========================================
// 発注管理（商社プラットフォーム機能）
// ========================================

model Supplier {
  id        String       @id @default(cuid())
  name      String
  code      String       @unique  // 仕入れ先コード
  email     String?
  phone     String?
  address   String?
  isActive  Boolean      @default(true)

  // 対応エリア（港名をカンマ区切りで保存、例: "佐世保港,長崎港,福岡港"）
  deliveryPorts String?

  ingredients Ingredient[]
  products    SupplierProduct[]

  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

// サプライヤーが提供する具体的な商品
// 抽象的な「食材」と、サプライヤーが実際に販売する「商品」を紐付ける
model SupplierProduct {
  id            String      @id @default(cuid())

  // サプライヤー
  supplier      Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  supplierId    String

  // 対応する食材（オプション：新規商品は食材マッピングなしで登録可能）
  ingredient    Ingredient? @relation(fields: [ingredientId], references: [id], onDelete: SetNull)
  ingredientId  String?

  // 商品情報
  productName   String      // 商品名（例：「熊本産トマト1kg」）
  productCode   String?     // 商品コード（サプライヤー側のSKU）
  description   String?     // 商品説明
  category      String?     // カテゴリ（野菜、肉、魚、調味料等）

  // 価格・単位
  price         Int         // 単価（円）
  unit          String      // 単位（kg, 個, 本, L等）
  minOrderQty   Float       @default(1)  // 最小発注量
  maxOrderQty   Float?      // 最大発注量（オプション）

  // 在庫・可用性
  isAvailable   Boolean     @default(true)  // 現在注文可能か
  isApproved    Boolean     @default(false) // WELLSHIP本部による承認済みか
  stockQty      Float?      // 在庫数量（オプション）
  leadDays      Int         @default(1)     // 配送までの日数

  // 画像（オプション）
  imageUrl      String?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([supplierId, productCode])
  @@index([supplierId])
  @@index([ingredientId])
  @@index([category])
  @@index([isAvailable])
}

model Order {
  id            String      @id @default(cuid())
  orderNumber   String      @unique  // 発注番号（自動採番）

  // 発注元
  vessel        Vessel      @relation(fields: [vesselId], references: [id], onDelete: Cascade)
  vesselId      String

  // 金額
  totalAmount   Int         @default(0)  // 合計金額（円）
  itemCount     Int         @default(0)  // 品目数

  // ステータス
  status        OrderStatus @default(DRAFT)

  // 配送情報
  deliveryDate  DateTime?   // 希望納品日
  deliveredAt   DateTime?   // 実際の納品日時
  shippingNote  String?     // 配送メモ

  // 明細
  items         OrderItem[]

  // タイムスタンプ
  confirmedAt   DateTime?   // 発注確定日時
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([vesselId])
  @@index([status])
  @@index([deliveryDate])
}

model OrderItem {
  id            String      @id @default(cuid())

  // 発注
  order         Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId       String

  // 食材
  ingredient    Ingredient  @relation(fields: [ingredientId], references: [id])
  ingredientId  String

  // 数量・金額
  quantity      Float       // 発注数量
  unit          String      // 単位（スナップショット）
  snapshotPrice Int         // 発注時点の単価（円）
  subtotal      Int         // 小計（snapshotPrice * quantity）

  // Boost食材フラグ（スナップショット）
  isBonus       Boolean     @default(false)

  createdAt     DateTime    @default(now())

  @@unique([orderId, ingredientId])
  @@index([orderId])
  @@index([ingredientId])
}
