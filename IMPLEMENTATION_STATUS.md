# WELLSHIP 実装ステータスと開発ロードマップ

**最終更新日:** 2026-01-28
**現在のフェーズ:** Phase 1 完了 / Phase 2 着手直前

---

## 1. プロジェクト概要

**WELLSHIP** は内航海運業界向けの「食と調達」のDXプラットフォームです。
船上での献立作成の自動化（AI司厨）と、それに連動した食材調達（マーケットプレイス）を一気通貫で提供します。

### 主要なアクターと責務
| ロール | URLパス | 責務 | 現状の実装度 |
|---|---|---|---|
| **Chef (司厨/船員)** | `/app/chef` | 献立作成、在庫管理、発注、フィードバック | 献立作成・フィードバックは完了。**調達・発注は未完**。 |
| **Manager (本部/運営)** | `/app/manager` | 船舶管理、サプライヤー管理、商品の承認、全社分析 | 船舶管理・サプライヤー承認フローは完了。 |
| **Supplier (業者)** | `/app/supplier` | 自社商品の登録、在庫・価格管理、受注対応 | **Phase 1で基盤実装完了**。商品登録が可能。 |

---

## 2. 実装済み機能詳細 (Phase 1: サプライヤー基盤整備)

「抽象的な食材」と「具体的な商品」を結びつけるための基盤を構築しました。

### A. データベーススキーマの拡張 (`prisma/schema.prisma`)
- **`Supplier`**: サプライヤー基本情報、配送可能港 (`deliveryPorts`)。
- **`SupplierProduct`**: 具体的な商品カタログ。
    - `isApproved`: 本部による承認フラグ（重要）。
    - `isAvailable`: サプライヤーによる在庫あり/なしスイッチ。
- **`Ingredient` への拡張**:
    - `SupplierProduct` とのリレーションを追加。
    - 商社機能用フィールド (`price`, `isBonus`, `supplierId`) を追加。
- **`Order`, `OrderItem`**: 発注データを格納するテーブルを作成（Supabase上でテーブル作成済み）。

### B. 機能・UIの実装
1.  **サプライヤー用画面 (`/app/supplier/products`)**
    -   サプライヤーが自社商品を登録・編集できる画面。
    -   商品追加時は `isApproved: false` (承認待ち) として登録される。
    -   在庫状況 (`isAvailable`) をワンクリックで切り替え可能。

2.  **本部用サプライヤー管理画面 (`/app/manager/suppliers`)**
    -   提携サプライヤーの一覧と、各社の商品カタログを表示。
    -   **承認フロー**: 本部が「承認」ボタンを押すことで、商品が船側に公開される (`isApproved: true`)。
    -   商品追加機能は削除（サプライヤー側に委譲）。

3.  **ロール切り替え機能**
    -   ヘッダー (`app-shell.tsx`) に「司厨」「本部」「業者」の切り替えボタンを実装。
    -   `UserRole` 型定義に `SUPPLIER` を追加。

4.  **APIエンドポイント**
    -   サプライヤー・商品管理用のCRUD API一式を実装済み。

---

## 3. 次に実装すべき機能 (Phase 2: 商品マッチングと発注)

**現状の課題:**
船側 (`Chef`) の調達リスト (`/procurement`) は、まだ「献立に必要な食材名」を表示しているだけで、実際の「サプライヤーの商品」と紐付いていません。そのため、正しい金額計算や発注確定ができない状態です。

### 📋 Phase 2 実装タスクリスト

この順序で実装を進めることを推奨します。

#### 1. 商品自動マッチングロジックの実装
献立から算出された「必要食材リスト」に対し、承認済みサプライヤー商品を自動で割り当てるロジックを作成します。

*   **入力:** 必要食材（例: トマト 5kg）, 配送希望港（例: 佐世保港）
*   **処理:**
    1.  その港に配送可能なサプライヤーをフィルタリング。
    2.  `Ingredient` と紐付いている `SupplierProduct` を検索。
    3.  `isApproved: true` かつ `isAvailable: true` の商品を抽出。
    4.  **AI/最適化**: 最安値、あるいは賞味期限や品質（メタデータがあれば）に基づいて最適な組み合わせを提案。

#### 2. 調達リスト画面 (`/app/chef/procurement`) の改修
*   **UI変更:**
    *   現在の「食材リスト」表示を、「サプライヤーごとの発注カート」形式に変更、あるいは食材ごとに採用された商品を表示する形式へ。
    *   **商品変更機能**: AIが提案した商品以外に、別の候補（他メーカー、他産地）があれば選択変更できるUI。
    *   **見積もり表示**: 商品選択に基づく正確な合計金額の表示。

#### 3. 発注確定アクションの実装
*   **処理:**
    *   「発注確定」ボタン押下時に `Order` および `OrderItem` テーブルへレコードを作成。
    *   サプライヤーごとに `Order` を分割して作成（例: 佐世保食品へ1伝票、九州青果へ1伝票）。
*   **通知:**
    *   (将来機能) サプライヤーへのメール通知/LINE通知。

---

## 4. 開発時の注意点

*   **環境**: Next.js (App Router), Supabase, Prisma, Tailwind CSS。
*   **データ**:
    *   開発中はマイグレーションファイル (`migrations/unified_migration.sql` 等) を使用してSupabaseのスキーマを同期してください。
    *   `add_isApproved_to_supplier_products.sql` は実行済みである必要があります。
*   **ユーザー**:
    *   開発環境では `wataru.1998.0606@gmail.com` でログイン時、ヘッダーから全ロールへ切り替え可能です。

---

## 5. ファイル構成 (主要部分のみ)

```text
/src
  /app
    /app
      /chef          # 司厨用 (Phase 2で /procurement を重点改修)
      /manager       # 本部用
        /suppliers   # サプライヤー管理・承認画面
      /supplier      # サプライヤー用
        /products    # 商品登録画面
      /api           # API群
  /components
    /manager         # 本部用パーツ
    /app-shell.tsx   # ヘッダー・ロール切り替え
  /lib
    /types           # 型定義
prisma
  schema.prisma      # DBスキーマ定義
  /migrations        # 生SQLマイグレーションファイル
```
